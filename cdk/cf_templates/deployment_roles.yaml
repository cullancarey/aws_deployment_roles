AWSTemplateFormatVersion: 2010-09-09

Description: >
  Creates an OIDC provider and separate roles for Terraform and CDK deployments via GitHub Actions.
  For more information on using OIDC to connect to AWS from GitHub Actions,
  see https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services.

Parameters:
  GithubActionsThumbprint:
    Type: CommaDelimitedList
    Default: 6938fd4d98bab03faadb97b34396831e3780aea1
    Description: >
      Comma seperated list of thumbprints for GitHub Actions tokens.
      Default comes from https://github.blog/changelog/2022-01-13-github-actions-update-on-oidc-based-deployments-to-aws/
  AudienceList:
    Type: CommaDelimitedList
    Default: sts.amazonaws.com
    Description: >
      Comma seperated list of allowed audience for the tokens.
      Default is audience for the official AWS configure action from https://github.com/aws-actions/configure-aws-credentials
  SubjectClaimFilters:
    Type: CommaDelimitedList
    Default: "repo:cullancarey/aws_deployment_roles:*"
    Description: >
      Subject claim filter for valid tokens.
      Default allows any branch or tag of the repository to assume the role.
      See https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#example-subject-claims
      for examples of filtering by branch or deployment environment.

Resources:
  GitHubIdentityProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ThumbprintList: !Ref GithubActionsThumbprint
      ClientIdList: !Ref AudienceList

  GitHubActionsTerraformDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      MaxSessionDuration: 3600
      RoleName: !Sub "GitHubActionsTerraformDeploymentRole-${AWS::Region}-${AWS::AccountId}"
      Path: /
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: RoleForGitHubActions
            Effect: Allow
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Action:
              - "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                "token.actions.githubusercontent.com:aud": !Ref AudienceList
              StringLike:
                "token.actions.githubusercontent.com:sub": !Ref SubjectClaimFilters
      Policies:
        - PolicyName: "TerraformDeploymentPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Core Terraform State Management
              - Effect: Allow
                Action:
                  - "dynamodb:DescribeStream"
                  - "dynamodb:DescribeTable" 
                  - "dynamodb:DescribeContinuousBackups"
                  - "dynamodb:DescribeTimeToLive"
                  - "dynamodb:ListTagsOfResource"
                  - "dynamodb:TagResource"
                Resource: "*"
              
              # KMS permissions for encryption/decryption
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                  - "kms:DescribeKey"
                  - "kms:GenerateDataKey"
                Resource: "*"
              
              # CloudWatch Logs for Terraform logging
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:CreateLogGroup"
                  - "logs:PutLogEvents"
                  - "logs:DescribeLogGroups"
                  - "logs:DescribeLogStreams"
                Resource: "*"
              
              # SSM Parameter Store access
              - Effect: Allow
                Action:
                  - "ssm:GetParameter"
                  - "ssm:GetParameters"
                  - "ssm:GetParametersByPath"
                Resource: "*"
              
              # ECR permissions for container deployments
              - Effect: Allow
                Action:
                  - "ecr:BatchCheckLayerAvailability"
                  - "ecr:BatchGetImage"
                  - "ecr:CompleteLayerUpload"
                  - "ecr:DescribeRepositories"
                  - "ecr:GetAuthorizationToken"
                  - "ecr:GetLifecyclePolicy"
                  - "ecr:InitiateLayerUpload"
                  - "ecr:ListTagsForResource"
                  - "ecr:PutImage"
                  - "ecr:UploadLayerPart"
                Resource: "*"
              
              # EventBridge permissions
              - Effect: Allow
                Action:
                  - "events:DescribeRule"
                  - "events:ListTagsForResource"
                  - "events:ListTargetsByRule"
                  - "events:TagResource"
                Resource: "*"
              
              # IAM permissions (read-only for resource discovery)
              - Effect: Allow
                Action:
                  - "iam:GetPolicy"
                  - "iam:GetPolicyVersion"
                  - "iam:GetRole"
                  - "iam:GetRolePolicy"
                  - "iam:ListAttachedRolePolicies"
                  - "iam:ListRolePolicies"
                  - "iam:TagRole"
                Resource: "*"
              
              # Lambda permissions
              - Effect: Allow
                Action:
                  - "lambda:DeleteLayerVersion20181031"
                  - "lambda:GetEventSourceMapping20150331"
                  - "lambda:GetFunction20150331v2"
                  - "lambda:GetFunctionCodeSigningConfig"
                  - "lambda:GetLayerVersion20181031"
                  - "lambda:GetPolicy20150331v2"
                  - "lambda:ListTags20170331"
                  - "lambda:ListVersionsByFunction20150331"
                  - "lambda:PublishLayerVersion20181031"
                  - "lambda:TagResource20170331v2"
                  - "lambda:UpdateFunctionConfiguration20150331v2"
                Resource: "*"
              
              # S3 permissions
              - Effect: Allow
                Action:
                  - "s3:GetAccelerateConfiguration"
                  - "s3:GetBucketAcl"
                  - "s3:GetBucketCors"
                  - "s3:GetBucketEncryption"
                  - "s3:GetBucketLifecycle"
                  - "s3:GetBucketLogging"
                  - "s3:GetBucketObjectLockConfiguration"
                  - "s3:GetBucketPolicy"
                  - "s3:GetBucketPublicAccessBlock"
                  - "s3:GetBucketReplication"
                  - "s3:GetBucketRequestPayment"
                  - "s3:GetBucketVersioning"
                  - "s3:GetBucketWebsite"
                  - "s3:ListTagsForResource"
                  - "s3:TagResource"
                Resource: "*"
              
              # STS permissions for role assumption and identity
              - Effect: Allow
                Action:
                  - "sts:AssumeRole"
                  - "sts:GetCallerIdentity"
                Resource: "*"
      Description: Service Role for Terraform deployments via GitHub Actions

  GitHubActionsCDKDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      MaxSessionDuration: 3600
      RoleName: !Sub "GitHubActionsCDKDeploymentRole-${AWS::Region}-${AWS::AccountId}"
      Path: /
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: RoleForGitHubActions
            Effect: Allow
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Action:
              - "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                "token.actions.githubusercontent.com:aud": !Ref AudienceList
              StringLike:
                "token.actions.githubusercontent.com:sub": !Ref SubjectClaimFilters
      Policies:
        - PolicyName: "CDKDeploymentPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CDK Bootstrap role assumption - the primary permission needed for CDK deployments
              - Effect: Allow
                Action:
                  - "sts:AssumeRole"
                Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role/cdk-hnb659fds-deploy-role-${AWS::AccountId}-*"
              
              # Basic STS permissions for identity verification
              - Effect: Allow
                Action:
                  - "sts:GetCallerIdentity"
                Resource: "*"
      Description: Service Role for CDK deployments via GitHub Actions

Outputs:
  GitHubIdentityProviderArn:
    Description: ARN of the GitHub OIDC Identity Provider
    Value: !GetAtt GitHubIdentityProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHubIdentityProviderArn"
  
  TerraformDeploymentRoleArn:
    Description: ARN of the GitHub Actions Terraform Deployment Role
    Value: !GetAtt GitHubActionsTerraformDeploymentRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TerraformDeploymentRoleArn"
  
  CDKDeploymentRoleArn:
    Description: ARN of the GitHub Actions CDK Deployment Role
    Value: !GetAtt GitHubActionsCDKDeploymentRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-CDKDeploymentRoleArn"